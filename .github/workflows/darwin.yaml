name: Build and Publish OpenGNB for macOS Intel and Apple Silicon

on:
  workflow_dispatch:

jobs:
  build_and_publish_opengnb:
    runs-on: macos-latest  # GitHub 提供的 macOS 运行环境（默认 arm64）

    env:
      RELEASE_NAME: opengnb_macos_1.6.a

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          repository: luoyueliang/gnb
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          ref: main  # 指定要检出的分支或提交

      - name: Install dependencies
        run: |
          brew install cmake ninja

      # 编译 x86_64 版本
      - name: Build binary for x86_64
        run: |
          export CC="clang -arch x86_64"
          export CXX="clang++ -arch x86_64"
          export LD="ld"
          export AR="ar"
          export RANLIB="ranlib"
          
          make -f Makefile.Darwin clean
          make -f Makefile.Darwin install

          # 打包 x86_64 版本
          mkdir -p release/macos_x86_64
          cp -r bin release/macos_x86_64/
          tar -czvf opengnb_macos_1.6.a_x86_64.tar.gz -C release/macos_x86_64 .
          echo "✅ x86_64 binary built and packaged"

      # 编译 arm64 版本
      - name: Build binary for arm64
        run: |
          export CC="clang -arch arm64"
          export CXX="clang++ -arch arm64"
          export LD="ld"
          export AR="ar"
          export RANLIB="ranlib"

          make -f Makefile.Darwin clean
          make -f Makefile.Darwin install

          # 打包 arm64 版本
          mkdir -p release/macos_arm64
          cp -r bin release/macos_arm64/
          tar -czvf opengnb_macos_1.6.a_arm64.tar.gz -C release/macos_arm64 .
          echo "✅ arm64 binary built and packaged"

      # 上传 x86_64 版本
      - name: Upload x86_64 Release Asset
        uses: softprops/action-gh-release@v1
        with:
            files: opengnb_macos_1.6.a_x86_64.tar.gz
            tag_name: v1.6.a
            body: |
              Release notes for v1.6.a (x86_64)
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 上传 arm64 版本
      - name: Upload arm64 Release Asset
        uses: softprops/action-gh-release@v1
        with:
            files: opengnb_macos_1.6.a_arm64.tar.gz
            tag_name: v1.6.a
            body: |
              Release notes for v1.6.a (arm64)
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
