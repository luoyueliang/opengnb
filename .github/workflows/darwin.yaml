name: Build and Publish OpenGNB for macOS Intel and Apple Silicon

on:
  workflow_dispatch:

jobs:
  build_and_publish_opengnb:
    runs-on: macos-latest  # GitHub æä¾›çš„ macOS è¿è¡Œç¯å¢ƒï¼ˆé»˜è®¤ arm64ï¼‰

    env:
      RELEASE_NAME: opengnb_macos_1.6.a

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          repository: luoyueliang/gnb
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          ref: main

      - name: Install dependencies
        run: |
          brew install cmake ninja

      - name: Modify Makefile for static linking
        run: |
          echo "ğŸ”§ ä¿®æ”¹ Makefile.Darwin ä»¥å¼ºåˆ¶ä½¿ç”¨é™æ€åº“..."
          sed -i '' 's|-L/usr/lib||g' Makefile.Darwin
          sed -i '' 's|CLI_LDFLAGS=.*|CLI_LDFLAGS=-pthread -static|g' Makefile.Darwin
          sed -i '' 's|GNB_ES_LDFLAGS=.*|GNB_ES_LDFLAGS=-pthread -static|g' Makefile.Darwin
          sed -i '' 's|-lssl|-l:libssl.a|g' Makefile.Darwin
          sed -i '' 's|-lcrypto|-l:libcrypto.a|g' Makefile.Darwin
          sed -i '' 's|-lz|-l:libz.a|g' Makefile.Darwin
          sed -i '' 's|-lminiupnpc|-l:libminiupnpc.a|g' Makefile.Darwin
          sed -i '' 's|-lnatpmp|-l:libnatpmp.a|g' Makefile.Darwin
          echo "âœ… Makefile.Darwin ä¿®æ”¹å®Œæˆï¼"

      # ç¼–è¯‘ x86_64 ç‰ˆæœ¬
      - name: Build binary for x86_64
        run: |
          export CC="clang -arch x86_64"
          export CXX="clang++ -arch x86_64"
          export LD="ld"
          export AR="ar"
          export RANLIB="ranlib"

          make -f Makefile.Darwin clean
          make -f Makefile.Darwin install

          # æ£€æŸ¥æ˜¯å¦ä»ç„¶é“¾æ¥åŠ¨æ€åº“
          echo "ğŸ” æ£€æŸ¥ x86_64 ç‰ˆæœ¬æ˜¯å¦åŒ…å«åŠ¨æ€åº“..."
          if otool -L bin/gnb | grep -q ".dylib"; then
            echo "âŒ ä»ç„¶ä¾èµ–åŠ¨æ€åº“ï¼"
            exit 1
          else
            echo "âœ… x86_64 ç‰ˆæœ¬å®Œå…¨é™æ€ï¼"
          fi

          # æ‰“åŒ… x86_64 ç‰ˆæœ¬
          mkdir -p release/macos_x86_64
          cp -r bin release/macos_x86_64/
          tar -czvf opengnb_macos_1.6.a_x86_64.tar.gz -C release/macos_x86_64 .
          echo "âœ… x86_64 binary built and packaged"

      # ç¼–è¯‘ arm64 ç‰ˆæœ¬
      - name: Build binary for arm64
        run: |
          export CC="clang -arch arm64"
          export CXX="clang++ -arch arm64"
          export LD="ld"
          export AR="ar"
          export RANLIB="ranlib"

          make -f Makefile.Darwin clean
          make -f Makefile.Darwin install

          # æ£€æŸ¥æ˜¯å¦ä»ç„¶é“¾æ¥åŠ¨æ€åº“
          echo "ğŸ” æ£€æŸ¥ arm64 ç‰ˆæœ¬æ˜¯å¦åŒ…å«åŠ¨æ€åº“..."
          if otool -L bin/gnb | grep -q ".dylib"; then
            echo "âŒ ä»ç„¶ä¾èµ–åŠ¨æ€åº“ï¼"
            exit 1
          else
            echo "âœ… arm64 ç‰ˆæœ¬å®Œå…¨é™æ€ï¼"
          fi

          # æ‰“åŒ… arm64 ç‰ˆæœ¬
          mkdir -p release/macos_arm64
          cp -r bin release/macos_arm64/
          tar -czvf opengnb_macos_1.6.a_arm64.tar.gz -C release/macos_arm64 .
          echo "âœ… arm64 binary built and packaged"

      # ä¸Šä¼  x86_64 ç‰ˆæœ¬
      - name: Upload x86_64 Release Asset
        uses: softprops/action-gh-release@v1
        with:
            files: opengnb_macos_1.6.a_x86_64.tar.gz
            tag_name: v1.6.a
            body: |
              Release notes for v1.6.a (x86_64)
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼  arm64 ç‰ˆæœ¬
      - name: Upload arm64 Release Asset
        uses: softprops/action-gh-release@v1
        with:
            files: opengnb_macos_1.6.a_arm64.tar.gz
            tag_name: v1.6.a
            body: |
              Release notes for v1.6.a (arm64)
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
